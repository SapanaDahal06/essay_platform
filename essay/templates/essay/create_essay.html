{% extends 'essay/base.html' %}
{% load static %}

{% block title %}Create New Essay - WriteVerse{% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .create-wrapper {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 60px 20px;
    }

    .create-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 30px;
        padding: 50px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    .create-header {
        text-align: center;
        margin-bottom: 50px;
    }

    .create-header h1 {
        font-size: 3.5rem;
        color: #333;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .create-header p {
        color: #666;
        font-size: 1.2rem;
        max-width: 700px;
        margin: 0 auto;
        line-height: 1.6;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
    }

    @media (max-width: 992px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-section {
        background: #f8f9fa;
        padding: 35px;
        border-radius: 20px;
        border: 2px solid #e9ecef;
    }

    .section-title {
        font-size: 1.8rem;
        color: #333;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        color: #667eea;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 14px 18px;
        font-size: 1.1rem;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        transition: all 0.3s;
        background: white;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .writing-mode-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .mode-option {
        flex: 1;
        padding: 20px;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .mode-option:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .mode-option.selected {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    .mode-option i {
        font-size: 2rem;
        margin-bottom: 10px;
        display: block;
    }

    .mode-option h4 {
        margin: 0 0 5px 0;
        font-size: 1.2rem;
    }

    .mode-option p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .language-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .language-option {
        padding: 20px;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        background: white;
    }

    .language-option:hover {
        border-color: #667eea;
        transform: translateY(-3px);
    }

    .language-option.selected {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    .language-flag {
        font-size: 2rem;
        margin-bottom: 10px;
        display: block;
    }

    .language-option span {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .language-option small {
        opacity: 0.8;
        font-size: 0.8rem;
    }

    .paragraph-settings {
        background: white;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 2px dashed #dee2e6;
    }

    .paragraph-info {
        color: #666;
        font-size: 0.9rem;
        margin-top: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .paragraph-info i {
        color: #667eea;
        margin-right: 8px;
    }

    #editor {
        height: 400px;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        background: white;
    }

    .ql-container {
        font-size: 1.05rem;
        line-height: 1.8;
        height: 320px;
    }

    .ql-editor {
        min-height: 320px;
        height: 100%;
    }

    .editor-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
    }

    .word-count {
        font-weight: 600;
        color: #666;
        font-size: 1rem;
    }

    .submit-container {
        text-align: center;
        margin-top: 50px;
    }

    .submit-btn {
        padding: 18px 50px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.3rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 12px;
    }

    .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .alert {
        padding: 20px;
        background: #d4edda;
        color: #155724;
        border-radius: 12px;
        margin-bottom: 30px;
        border-left: 5px solid #28a745;
        font-weight: 600;
    }

    .alert.error {
        background: #f8d7da;
        color: #721c24;
        border-left-color: #dc3545;
    }

    .feature-badge {
        display: inline-block;
        padding: 6px 12px;
        background: #e9ecef;
        color: #495057;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 10px;
    }
</style>

<div class="create-wrapper">
    <div class="create-container">
        <div class="create-header">
            <h1>‚úçÔ∏è Create New Essay</h1>
            <p>Choose your writing mode, select language, and start creating your masterpiece</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}error{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" id="essayForm">
            {% csrf_token %}
            
            <div class="form-grid">
                <!-- Left Column: Essay Settings -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-cog"></i> Essay Settings
                    </h2>

                    <div class="form-group">
                        <label for="title">Essay Title *</label>
                        <input 
                            type="text" 
                            id="title" 
                            name="title" 
                            placeholder="Enter your essay title..."
                            required
                            value="{{ essay.title|default:'' }}"
                        >
                    </div>

                    <div class="form-group">
                        <label>Writing Mode</label>
                        <div class="writing-mode-selector">
                            <div class="mode-option" data-mode="normal">
                                <i>üìù</i>
                                <h4>Normal Mode</h4>
                                <p>Write freely, edit anytime</p>
                            </div>
                            <div class="mode-option" data-mode="paragraph">
                                <i>üîí</i>
                                <h4>Paragraph Mode <span class="feature-badge">NEW</span></h4>
                                <p>Paragraphs lock as you progress</p>
                            </div>
                        </div>
                        <input type="hidden" id="writing_mode" name="writing_mode" value="normal">
                    </div>

                    <div class="form-group">
                        <label>Select Language</label>
                        <div class="language-selector">
                            {% for language in languages %}
                                <div class="language-option {% if preferred_language and language.id == preferred_language.id %}selected{% endif %}" 
                                     data-language-id="{{ language.id }}">
                                    <span class="language-flag">
                                        {% if language.code == 'en' %}üá∫üá∏{% endif %}
                                        {% if language.code == 'ne' %}üá≥üáµ{% endif %}
                                        {% if language.code not in 'en,ne' %}üåê{% endif %}
                                    </span>
                                    <span>{{ language.name }}</span>
                                    <small>{{ language.code|upper }}</small>
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="language_id" name="language_id" value="{{ preferred_language.id|default:'' }}">
                    </div>

                    <div id="paragraphSettings" class="paragraph-settings" style="display: none;">
                        <div class="form-group">
                            <label for="max_paragraphs">Number of Paragraphs</label>
                            <input 
                                type="number" 
                                id="max_paragraphs" 
                                name="max_paragraphs" 
                                min="3" 
                                max="20" 
                                value="5"
                                class="form-control"
                            >
                            <div class="paragraph-info">
                                <i class="fas fa-info-circle"></i>
                                Each paragraph will lock after you start writing the next one. You can't edit locked paragraphs.
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category">
                            <option value="general">General</option>
                            <option value="education">Education</option>
                            <option value="technology">Technology</option>
                            <option value="environment">Environment</option>
                            <option value="creative">Creative Writing</option>
                        </select>
                    </div>
                </div>

                <!-- Right Column: Essay Content -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-edit"></i> Essay Content
                    </h2>

                    <div class="form-group">
                        <label for="editor">Write Your Essay *</label>
                        <div id="editor"></div>
                        <input type="hidden" id="content" name="content">
                        
                        <div class="editor-footer">
                            <div class="word-count">
                                Words: <span id="wordCount">0</span>
                            </div>
                            <div>
                                <button type="button" id="formatHelp" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-question-circle"></i> Formatting Help
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="paragraph-info">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> In Paragraph Mode, write your first paragraph here. 
                            Additional paragraphs will be written one by one after this.
                        </div>
                    </div>
                </div>
            </div>

            <div class="submit-container">
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-rocket"></i> Start Writing Journey
                </button>
                <div style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    <i class="fas fa-shield-alt"></i> Your essay will be automatically saved and a PDF will be generated
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    let quill;
    let currentMode = 'normal';
    let selectedLanguageId = '{{ preferred_language.id|default:"" }}';

    // Initialize Quill Editor
    function initQuill() {
        if (!quill) {
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link'],
                        ['clean']
                    ]
                },
                placeholder: 'Start writing your essay here...'
            });

            // Update word count
            quill.on('text-change', function() {
                const text = quill.getText().trim();
                const words = text ? text.split(/\s+/).length : 0;
                document.getElementById('wordCount').textContent = words;
            });
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initQuill();
        
        // Writing mode selection
        document.querySelectorAll('.mode-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Update hidden input
                currentMode = this.dataset.mode;
                document.getElementById('writing_mode').value = currentMode;
                
                // Show/hide paragraph settings
                const paragraphSettings = document.getElementById('paragraphSettings');
                if (currentMode === 'paragraph') {
                    paragraphSettings.style.display = 'block';
                    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-paragraph"></i> Start Paragraph Writing';
                } else {
                    paragraphSettings.style.display = 'none';
                    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-rocket"></i> Start Writing Journey';
                }
            });
        });

        // Language selection
        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                document.querySelectorAll('.language-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Update hidden input
                selectedLanguageId = this.dataset.languageId;
                document.getElementById('language_id').value = selectedLanguageId;
                
                // Show language change message
                const langName = this.querySelector('span').textContent;
                showToast(`Language set to: ${langName}`);
            });
        });

        // Format help button
        document.getElementById('formatHelp').addEventListener('click', function() {
            alert('Formatting Help:\n\n' +
                  '‚Ä¢ Use headings to organize your essay\n' +
                  '‚Ä¢ Use bold/italic for emphasis\n' +
                  '‚Ä¢ Use bullet points for lists\n' +
                  '‚Ä¢ Add links to references\n' +
                  '‚Ä¢ In Paragraph Mode, only current paragraph can be edited');
        });

        // Form submission
        document.getElementById('essayForm').addEventListener('submit', function(event) {
            event.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const content = quill.root.innerHTML;
            const textContent = quill.getText().trim();
            
            if (!title) {
                alert('Please enter an essay title!');
                document.getElementById('title').focus();
                return;
            }
            
            if (!textContent) {
                alert('Please write your essay content!');
                quill.focus();
                return;
            }
            
            if (currentMode === 'paragraph') {
                const maxParagraphs = document.getElementById('max_paragraphs').value;
                if (maxParagraphs < 3 || maxParagraphs > 20) {
                    alert('Number of paragraphs must be between 3 and 20!');
                    return;
                }
            }
            
            // Set the hidden content field
            document.getElementById('content').value = content;
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Essay...';
            submitBtn.disabled = true;
            
            // Submit the form
            this.submit();
        });

        // Show default selected mode
        document.querySelector('.mode-option[data-mode="normal"]').classList.add('selected');
    });

    function showToast(message) {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(toast);
        
        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Add CSS animations for toast
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}