{% extends 'essay/base.html' %}
{% load static %}

{% block title %}Create New Essay - WriteVerse{% endblock %}

{% block content %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .create-wrapper {
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 60px 20px;
    }

    .create-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 30px;
        padding: 50px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
    }

    .create-header {
        text-align: center;
        margin-bottom: 50px;
    }

    .create-header h1 {
        font-size: 3.5rem;
        color: #333;
        margin-bottom: 15px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .create-header p {
        color: #666;
        font-size: 1.2rem;
        max-width: 700px;
        margin: 0 auto;
        line-height: 1.6;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
    }

    @media (max-width: 992px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-section {
        background: #f8f9fa;
        padding: 35px;
        border-radius: 20px;
        border: 2px solid #e9ecef;
    }

    .section-title {
        font-size: 1.8rem;
        color: #333;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .section-title i {
        color: #667eea;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 14px 18px;
        font-size: 1.1rem;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        transition: all 0.3s;
        background: white;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .language-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .language-option {
        padding: 20px;
        border: 2px solid #dee2e6;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        background: white;
    }

    .language-option:hover {
        border-color: #667eea;
        transform: translateY(-3px);
    }

    .language-option.selected {
        border-color: #667eea;
        background: #667eea;
        color: white;
    }

    .language-flag {
        font-size: 2rem;
        margin-bottom: 10px;
        display: block;
    }

    .language-option span {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
    }

    .language-option small {
        opacity: 0.8;
        font-size: 0.8rem;
    }

    .paragraph-settings {
        background: white;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 2px dashed #dee2e6;
    }

    .paragraph-info {
        color: #666;
        font-size: 0.9rem;
        margin-top: 10px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .paragraph-info i {
        color: #667eea;
        margin-right: 8px;
    }

    #editor {
        display: none; /* Hidden completely */
    }

    .editor-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
    }

    .word-count {
        font-weight: 600;
        color: #666;
        font-size: 1rem;
    }

    .submit-container {
        text-align: center;
        margin-top: 50px;
    }

    .submit-btn {
        padding: 18px 50px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 1.3rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 12px;
    }

    .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .alert {
        padding: 20px;
        background: #d4edda;
        color: #155724;
        border-radius: 12px;
        margin-bottom: 30px;
        border-left: 5px solid #28a745;
        font-weight: 600;
    }

    .alert.error {
        background: #f8d7da;
        color: #721c24;
        border-left-color: #dc3545;
    }

    /* === SECURE WRITING AREA === */
    #secureWritingArea {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        background: #fafafa;
        margin-top: 20px;
    }

    .secure-instructions {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        color: #495057;
    }

    .secure-instructions h4 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .secure-instructions ul {
        margin: 10px 0 0 20px;
        list-style: none;
    }

    .secure-instructions li {
        margin: 8px 0;
        padding-left: 25px;
        position: relative;
    }

    .secure-instructions li:before {
        content: "‚úì";
        position: absolute;
        left: 0;
        color: #667eea;
        font-weight: bold;
    }

    .paragraphs-container {
        min-height: 300px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-size: 1.05rem;
        line-height: 1.8;
    }

    .paragraph {
        min-height: 28px;
        padding: 15px;
        margin: 12px 0;
        border-radius: 8px;
        line-height: 1.6;
        outline: none;
        transition: all 0.3s;
        font-size: 1.1rem;
    }

    .active-paragraph {
        background: #f0f4ff;
        border-left: 3px solid #667eea;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    }

    .active-paragraph:focus {
        background: #fffde7;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .locked-paragraph {
        background: #f8f9fa;
        border-left: 3px solid #28a745;
        color: #495057;
        cursor: not-allowed;
        position: relative;
        font-size: 1.1rem;
        line-height: 1.6;
    }

    .lock-icon {
        float: right;
        font-size: 12px;
        opacity: 0.5;
        margin-left: 10px;
    }

    .writing-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        font-size: 0.9rem;
        color: white;
        font-weight: 600;
    }

    .writing-stats span {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .security-warning {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #ff6b6b;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        max-width: 350px;
        font-weight: 600;
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    .toast-message {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #667eea;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    }
</style>

<div class="create-wrapper">
    <div class="create-container">
        <div class="create-header">
            <h1>‚úçÔ∏è Create New Essay</h1>
            <p>Write in secure paragraph mode - paragraphs lock as you progress</p>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}error{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" id="essayForm" action="{% url 'create_essay' %}">
            {% csrf_token %}
            
            <div class="form-grid">
                <!-- Left Column: Essay Settings -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-cog"></i> Essay Settings
                    </h2>

                    <div class="form-group">
                        <label for="title">Essay Title *</label>
                        <input 
                            type="text" 
                            id="title" 
                            name="title" 
                            placeholder="Enter your essay title..."
                            required
                            value="{{ essay.title|default:'' }}"
                        >
                    </div>

                    <div class="form-group">
                        <label>Writing Mode</label>
                        <div style="
                            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
                            border-left: 4px solid #667eea;
                            padding: 20px;
                            border-radius: 12px;
                            margin-bottom: 20px;
                            text-align: center;
                        ">
                            <h4 style="color: #667eea; margin-bottom: 10px;">
                                <i class="fas fa-shield-alt"></i> Secure Paragraph Mode
                            </h4>
                            <p style="color: #495057; margin-bottom: 10px;">
                                <strong>Rules:</strong> Paragraphs lock on Enter ‚Ä¢ No external copy/paste
                            </p>
                        </div>
                        <input type="hidden" id="writing_mode" name="writing_mode" value="paragraph">
                    </div>

                    <div class="form-group">
                        <label>Select Language</label>
                        <div class="language-selector">
                            {% for language in languages %}
                                <div class="language-option {% if preferred_language and language.id == preferred_language.id %}selected{% endif %}" 
                                     data-language-id="{{ language.id }}">
                                    <span class="language-flag">
                                        {% if language.code == 'en' %}üá∫üá∏{% endif %}
                                        {% if language.code == 'ne' %}üá≥üáµ{% endif %}
                                        {% if language.code not in 'en,ne' %}üåê{% endif %}
                                    </span>
                                    <span>{{ language.name }}</span>
                                    <small>{{ language.code|upper }}</small>
                                </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" id="language_id" name="language_id" value="{{ preferred_language.id|default:'' }}">
                    </div>

                    <div class="paragraph-settings">
                        <div class="form-group">
                            <label for="max_paragraphs">Number of Paragraphs</label>
                            <input 
                                type="number" 
                                id="max_paragraphs" 
                                name="max_paragraphs" 
                                min="3" 
                                max="20" 
                                value="5"
                                class="form-control"
                            >
                            <div class="paragraph-info">
                                <i class="fas fa-info-circle"></i>
                                Press ENTER to lock a paragraph and start a new one.
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="category">Category</label>
                        <select id="category" name="category">
                            <option value="general">General</option>
                            <option value="education">Education</option>
                            <option value="technology">Technology</option>
                            <option value="environment">Environment</option>
                            <option value="creative">Creative Writing</option>
                        </select>
                    </div>
                </div>

                <!-- Right Column: Essay Content -->
                <div class="form-section">
                    <h2 class="section-title">
                        <i class="fas fa-edit"></i> Essay Content
                    </h2>

                    <div class="form-group">
                        <label for="editor">Write Your Essay *</label>
                        
                        <!-- Secure Writing Area (Only Mode) -->
                        <div id="secureWritingArea">
                            <div class="secure-instructions">
                                <h4><i class="fas fa-shield-alt"></i> Secure Writing Rules:</h4>
                                <ul>
                                    <li>Press <strong>ENTER</strong> to lock a paragraph</li>
                                    <li>Locked paragraphs cannot be edited</li>
                                    <li>No external copy/paste allowed</li>
                                    <li>Focus on your thoughts and flow</li>
                                </ul>
                            </div>
                            
                            <div id="paragraphsContainer" class="paragraphs-container">
                                <div class="paragraph active-paragraph" contenteditable="true" spellcheck="false" data-paragraph="1"></div>
                            </div>
                            
                            <div class="writing-stats">
                                <span>Paragraphs: <span id="paraCount">1</span>/<span id="maxPara">5</span></span>
                                <span>Words: <span id="secureWordCount">0</span></span>
                                <span>Status: <span id="writingStatus">Ready</span></span>
                            </div>
                        </div>
                        
                        <!-- Hidden Fields for Content -->
                        <input type="hidden" id="content" name="content">
                        <input type="hidden" id="formatted_content" name="formatted_content">
                        
                        <div class="editor-footer">
                            <div class="word-count">
                                Words: <span id="wordCount">0</span>
                            </div>
                            <div>
                                <button type="button" id="formatHelp" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-question-circle"></i> Help
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="paragraph-info">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> Write freely without worrying about mistakes. Each paragraph locks as you progress.
                        </div>
                    </div>
                </div>
            </div>

            <div class="submit-container">
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-paragraph"></i> Create Essay
                </button>
                <div style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    <i class="fas fa-shield-alt"></i> Your essay will be saved securely
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// ================== SIMPLE SECURE WRITING JAVASCRIPT ==================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Secure paragraph mode initialized');
    
    // Initialize first paragraph
    const firstPara = document.querySelector('#secureWritingArea .paragraph');
    if (firstPara) firstPara.focus();
    
    // 1. PARAGRAPH LOCKING ON ENTER
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            
            const currentPara = document.querySelector('.paragraph[contenteditable="true"]:focus');
            if (!currentPara) return;
            
            // Check if paragraph has content
            if (currentPara.textContent.trim() === '') {
                showToast('Write something before locking paragraph!');
                return;
            }
            
            // Check max paragraphs
            const maxParas = parseInt(document.getElementById('max_paragraphs').value);
            const currentCount = document.querySelectorAll('.paragraph').length;
            if (currentCount >= maxParas) {
                showToast(`Maximum ${maxParas} paragraphs reached!`);
                return;
            }
            
            // Lock current paragraph
            currentPara.removeAttribute('contenteditable');
            currentPara.classList.remove('active-paragraph');
            currentPara.classList.add('locked-paragraph');
            
            // Add lock icon
            const lockIcon = document.createElement('span');
            lockIcon.className = 'lock-icon';
            lockIcon.innerHTML = 'üîí';
            currentPara.appendChild(lockIcon);
            
            // Create new paragraph
            const newPara = document.createElement('div');
            newPara.className = 'paragraph active-paragraph';
            newPara.setAttribute('contenteditable', 'true');
            newPara.setAttribute('spellcheck', 'false');
            newPara.innerHTML = '<br>';
            
            document.getElementById('paragraphsContainer').appendChild(newPara);
            
            // Focus on new paragraph
            setTimeout(() => newPara.focus(), 10);
            
            // Update counters
            updateCounters();
            showToast('Paragraph locked! Start next one.');
        }
    });
    
    // 2. BLOCK EXTERNAL COPY/PASTE
    document.addEventListener('paste', function(e) {
        e.preventDefault();
        showWarning('‚ö†Ô∏è External copy-paste disabled. Type your own content.');
    });
    
    document.addEventListener('copy', function(e) {
        // Allow copying only from active paragraphs
        const target = e.target;
        if (!target.classList.contains('paragraph') || 
            target.classList.contains('locked-paragraph')) {
            e.preventDefault();
        }
    });
    
    // 3. UPDATE COUNTERS ON INPUT
    document.addEventListener('input', updateCounters);
    
    // 4. FORM SUBMISSION
    document.getElementById('essayForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const title = document.getElementById('title').value.trim();
        if (!title) {
            alert('Please enter an essay title!');
            document.getElementById('title').focus();
            return;
        }
        
        // Collect content from paragraphs
        const paragraphs = document.querySelectorAll('#secureWritingArea .paragraph');
        let plainText = [];
        let htmlContent = [];
        
        paragraphs.forEach((para, index) => {
            const text = para.textContent.replace('üîí', '').trim();
            if (text) {
                plainText.push(text);
                // Get HTML content (preserves formatting)
                let html = para.innerHTML.replace(/üîí/g, '').trim();
                htmlContent.push(html);
            }
        });
        
        if (plainText.length === 0) {
            alert('Please write some content in your essay!');
            document.querySelector('#secureWritingArea .paragraph').focus();
            return;
        }
        
        // Set content fields
        document.getElementById('content').value = plainText.join('\n\n');
        document.getElementById('formatted_content').value = htmlContent.join('<br><br>');
        
        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        submitBtn.disabled = true;
        
        // Submit form
        console.log('Submitting essay with formatted content');
        setTimeout(() => {
            this.submit();
        }, 500);
    });
    
    // 5. LANGUAGE SELECTION
    document.querySelectorAll('.language-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.language-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            this.classList.add('selected');
            const langId = this.dataset.languageId;
            document.getElementById('language_id').value = langId;
            
            const langName = this.querySelector('span').textContent;
            showToast(`Language: ${langName}`);
        });
    });
    
    // 6. FORMAT HELP
    document.getElementById('formatHelp').addEventListener('click', function() {
        alert('HOW TO WRITE:\n\n' +
              '1. Type your paragraph\n' +
              '2. Press ENTER to lock it\n' +
              '3. A new paragraph will appear\n' +
              '4. Repeat until done\n' +
              '5. Click "Create Essay" to save\n\n' +
              'NOTE: Locked paragraphs cannot be edited.');
    });
    
    // 7. MAX PARAGRAPHS CHANGE
    document.getElementById('max_paragraphs').addEventListener('change', function() {
        document.getElementById('maxPara').textContent = this.value;
    });
    
    // HELPER FUNCTIONS
    function updateCounters() {
        const paragraphs = document.querySelectorAll('#secureWritingArea .paragraph');
        let totalWords = 0;
        let lockedCount = 0;
        
        paragraphs.forEach(para => {
            const text = para.textContent.replace('üîí', '').trim();
            if (text) {
                totalWords += text.split(/\s+/).length;
                if (para.classList.contains('locked-paragraph')) {
                    lockedCount++;
                }
            }
        });
        
        // Update all counters
        document.getElementById('secureWordCount').textContent = totalWords;
        document.getElementById('wordCount').textContent = totalWords;
        document.getElementById('paraCount').textContent = paragraphs.length;
        
        // Update status
        const statusEl = document.getElementById('writingStatus');
        if (lockedCount > 0) {
            statusEl.textContent = `${lockedCount} locked`;
            statusEl.style.color = '#28a745';
        } else {
            statusEl.textContent = 'Writing...';
            statusEl.style.color = '#667eea';
        }
        
        return totalWords;
    }
    
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }
    
    function showWarning(message) {
        const warning = document.createElement('div');
        warning.className = 'security-warning';
        warning.textContent = message;
        document.body.appendChild(warning);
        setTimeout(() => {
            warning.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => warning.remove(), 300);
        }, 3000);
    }
    
    // Initialize counters
    updateCounters();
});
</script>
{% endblock %}