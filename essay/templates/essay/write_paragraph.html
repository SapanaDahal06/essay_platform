{% comment %} <!DOCTYPE html>
<html>
<head>
    <title>Paragraph Writer - {{ essay.title }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; }
        .progress-bar { height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress { height: 100%; background: #4CAF50; width: {{ essay.get_paragraph_progress }}%; }
        .paragraph-container { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .paragraph-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .para-title { font-size: 18px; font-weight: bold; color: #333; }
        .status { padding: 5px 10px; border-radius: 5px; font-size: 12px; }
        .status-current { background: #2196F3; color: white; }
        .status-locked { background: #4CAF50; color: white; }
        .status-upcoming { background: #9E9E9E; color: white; }
        textarea { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; min-height: 150px; font-family: Arial; }
        textarea:disabled { background: #f9f9f9; }
        .actions { margin-top: 15px; display: flex; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #9E9E9E; color: white; }
        .main-actions { display: flex; justify-content: space-between; margin-top: 30px; padding: 20px; background: white; border-radius: 10px; }
        .language-select { padding: 8px; border-radius: 5px; border: 1px solid #ddd; }
        .grammar-issues { margin-top: 10px; padding: 10px; background: #FFF3CD; border-left: 4px solid #FFC107; border-radius: 5px; display: none; }
        .issue { margin: 5px 0; padding: 5px; background: #FFECB3; border-radius: 3px; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px; background: #333; color: white; border-radius: 5px; display: none; z-index: 1000; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>{{ essay.title }}</h1>
            <p>Write your essay paragraph by paragraph</p>
            
            <!-- Progress -->
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
            <p>Progress: {{ essay.current_paragraph }}/{{ essay.max_paragraphs }} paragraphs ({{ essay.get_paragraph_progress|floatformat:0 }}%)</p>
            
            <!-- Language Selection -->
            <div style="margin-top: 15px;">
                <label>Grammar Check Language:</label>
                <select id="language" class="language-select">
                    <option value="en-US">English (US)</option>
                    <option value="ne">Nepali (नेपाली)</option>
                    <option value="en-GB">English (UK)</option>
                </select>
            </div>
        </div>

        <!-- Paragraphs -->
        {% for i in max_paragraphs %}
        <div class="paragraph-container" id="para-{{ i }}">
            <div class="paragraph-header">
                <div class="para-title">Paragraph {{ i }}</div>
                <div class="status 
                    {% if i < essay.current_paragraph %}status-locked
                    {% elif i == essay.current_paragraph %}status-current
                    {% else %}status-upcoming{% endif %}">
                    {% if i < essay.current_paragraph %}✓ Completed
                    {% elif i == essay.current_paragraph %}✎ Current
                    {% else %}⏱ Upcoming{% endif %}
                </div>
            </div>
            
            <textarea id="text-{{ i }}" 
                {% if i > essay.current_paragraph %}disabled{% endif %}
                placeholder="Write paragraph {{ i }} here...">{{ paragraphs.i.content }}</textarea>
            
            <div class="actions">
                <button class="btn-primary check-grammar" data-para="{{ i }}">Check Grammar</button>
                <button class="btn-success save-para" data-para="{{ i }}">Save Paragraph</button>
                {% if i < essay.current_paragraph %}
                <button class="btn-warning unlock-para" data-para="{{ i }}">Unlock for Editing</button>
                {% endif %}
            </div>
            
            <div class="grammar-issues" id="issues-{{ i }}"></div>
        </div>
        {% endfor %}

        <!-- Main Action Buttons -->
        <div class="main-actions">
            <div>
                <button id="prev-btn" class="btn-secondary">← Previous</button>
                <button id="next-btn" class="btn-primary">Next →</button>
            </div>
            
            <div>
                <button id="edit-all-btn" class="btn-warning">Edit All Paragraphs</button>
                <button id="save-draft-btn" class="btn-primary">Save as Draft</button>
                <button id="final-submit-btn" class="btn-success">Final Submit</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        const essayId = "{{ essay.id }}";
        const currentPara = {{ essay.current_paragraph }};
        const maxParas = {{ essay.max_paragraphs }};
        
        // Show notification
        function showMessage(text, type = 'info') {
            const notif = document.getElementById('notification');
            notif.textContent = text;
            notif.style.background = type === 'error' ? '#f44336' : 
                                   type === 'success' ? '#4CAF50' : '#2196F3';
            notif.style.display = 'block';
            setTimeout(() => notif.style.display = 'none', 3000);
        }
        
        // Save paragraph
        function saveParagraph(paraNum) {
            const text = document.getElementById('text-' + paraNum).value;
            const language = document.getElementById('language').value;
            
            fetch('/api/save-paragraph/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    essay_id: essayId,
                    content: text,
                    paragraph_num: paraNum,
                    language: language
                })
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    showMessage(`Paragraph ${paraNum} saved!`, 'success');
                } else {
                    showMessage(`Error: ${data.error}`, 'error');
                }
            });
        }
        
        // Check grammar
        function checkGrammar(paraNum) {
            const text = document.getElementById('text-' + paraNum).value;
            const language = document.getElementById('language').value;
            
            if(!text.trim()) {
                showMessage('Please write something first', 'error');
                return;
            }
            
            fetch('/api/check-grammar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    text: text,
                    language: language
                })
            })
            .then(r => r.json())
            .then(data => {
                const issuesDiv = document.getElementById('issues-' + paraNum);
                issuesDiv.innerHTML = '';
                issuesDiv.style.display = 'block';
                
                if(data.issues && data.issues.length > 0) {
                    data.issues.forEach(issue => {
                        const div = document.createElement('div');
                        div.className = 'issue';
                        div.innerHTML = `<strong>${issue.type}:</strong> ${issue.message}`;
                        if(issue.suggestion) {
                            div.innerHTML += `<br><em>→ ${issue.suggestion}</em>`;
                        }
                        issuesDiv.appendChild(div);
                    });
                    showMessage(`Found ${data.issues.length} grammar issues`, 'warning');
                } else {
                    issuesDiv.innerHTML = '<div class="issue">✓ No grammar issues found! Excellent writing!</div>';
                    showMessage('No grammar issues found!', 'success');
                }
            });
        }
        
        // Unlock paragraph
        function unlockParagraph(paraNum) {
            const textarea = document.getElementById('text-' + paraNum);
            textarea.disabled = false;
            textarea.focus();
            showMessage(`Paragraph ${paraNum} unlocked for editing`, 'info');
        }
        
        // Event listeners
        document.querySelectorAll('.save-para').forEach(btn => {
            btn.addEventListener('click', function() {
                const paraNum = this.dataset.para;
                saveParagraph(paraNum);
            });
        });
        
        document.querySelectorAll('.check-grammar').forEach(btn => {
            btn.addEventListener('click', function() {
                const paraNum = this.dataset.para;
                checkGrammar(paraNum);
            });
        });
        
        document.querySelectorAll('.unlock-para').forEach(btn => {
            btn.addEventListener('click', function() {
                const paraNum = this.dataset.para;
                unlockParagraph(paraNum);
            });
        });
        
        // Navigation
        document.getElementById('prev-btn').addEventListener('click', function() {
            if(currentPara > 1) {
                saveParagraph(currentPara);
                window.location.href = `?paragraph=${currentPara - 1}`;
            }
        });
        
        document.getElementById('next-btn').addEventListener('click', function() {
            if(currentPara < maxParas) {
                const text = document.getElementById('text-' + currentPara).value;
                if(!text.trim()) {
                    showMessage('Please write something before moving on', 'error');
                    return;
                }
                saveParagraph(currentPara);
                window.location.href = `?paragraph=${currentPara + 1}`;
            }
        });
        
        // Edit all mode
        let editMode = false;
        document.getElementById('edit-all-btn').addEventListener('click', function() {
            editMode = !editMode;
            
            if(editMode) {
                this.textContent = 'Exit Edit Mode';
                this.classList.remove('btn-warning');
                this.classList.add('btn-danger');
                
                // Enable all textareas
                for(let i = 1; i <= maxParas; i++) {
                    document.getElementById('text-' + i).disabled = false;
                }
                
                showMessage('Edit Mode: All paragraphs unlocked', 'warning');
            } else {
                window.location.reload();
            }
        });
        
        // Save draft
        document.getElementById('save-draft-btn').addEventListener('click', function() {
            for(let i = 1; i <= currentPara; i++) {
                saveParagraph(i);
            }
            showMessage('Essay saved as draft!', 'success');
        });
        
        // Final submit
        document.getElementById('final-submit-btn').addEventListener('click', function() {
            if(confirm('Submit essay? PDF will be generated automatically.')) {
                fetch('/api/submit-essay/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        essay_id: essayId
                    })
                })
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        showMessage('Essay submitted successfully!', 'success');
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 2000);
                    } else {
                        showMessage(`Error: ${data.error}`, 'error');
                    }
                });
            }
        });
        
        // Auto-save
        setInterval(() => {
            saveParagraph(currentPara);
        }, 30000);
    </script>
</body>
</html> {% endcomment %}

<!-- In templates/essay/write_paragraph.html -->
{% extends 'essay/base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <!-- Your existing header/title code -->
    
    <!-- Add instructions banner -->
    <div class="alert alert-info secure-instructions">
        <h5><i class="fas fa-shield-alt"></i> Secure Writing Mode</h5>
        <ul class="mb-0">
            <li><strong>Press Enter</strong> to lock a paragraph (cannot be edited after)</li>
            <li><strong>External copy/paste is disabled</strong> - Type everything yourself</li>
            <li><strong>Typing mistakes are hidden</strong> while you're typing</li>
            <li>Focus on your thoughts, not corrections</li>
        </ul>
    </div>
    
    <!-- Your existing essay editor - make sure it has this structure -->
    <div id="essay-editor" class="essay-editor" contenteditable="true">
        {% if essay.content %}
            <!-- Display existing content as locked paragraphs -->
            {% for paragraph in essay.content|linebreaksbr|split_paragraphs %}
            <p class="locked-paragraph">{{ paragraph }}</p>
            {% endfor %}
            <!-- Add one editable paragraph at the end -->
            <p class="editable-paragraph" contenteditable="true"><br></p>
        {% else %}
            <p class="editable-paragraph" contenteditable="true">Start typing your essay here...</p>
        {% endif %}
    </div>
    
    <!-- Your existing buttons/save form -->
    <form method="POST" id="essay-form">
        {% csrf_token %}
        <input type="hidden" name="content" id="essay-content">
        <button type="submit" class="btn btn-primary">Save Essay</button>
    </form>
</div>

<!-- Load the secure writing JavaScript -->
<script src="{% static 'essay/js/secure_input.js' %}"></script>
{% endblock %}